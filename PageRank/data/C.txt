Conception du Modèle de Base de Données et d'Accès Utilisateur

1) Objectifs: 
 
 Etablir une startégie de base de données Multi-Tenant pour l'isolation des applications 
 Mettre en Oeuvre le principe du moindre privilège ( PoLP ) 
 Contrôle d'accès basé sur les rôles 
 Sécuriser le schéma public 
 
 2) Choix d'architecture multi-tenant : 
 
 
 Base par tenant (DB par tenant) 
 
 Isolation forte (sécurité, backups/restores par tenant). 
 Recommandé si SLA/isolement légal requiert séparation (ex : clients entreprise), ou possibilité de restore individuel. 
 
 
 
 Schéma par tenant (schema per tenant) 
 
 Bon compromis : isolation logique (objets séparés), un seul cluster/DB à gérer, moins de connexions. 
 Sauvegarde/restauration plus complexe au niveau d’un schema mais faisable. 
 Recommandé pour centaines de tenants, et besoin de séparation modérée. 
 
 
 
 La pratique la plus fondamentale pour l'isolation des données est de créer une base de données distincte pour chaque application : wiki_db , keycloak_db , n8n_db , etc. Cette séparation au plus haut niveau logique garantit qu'un utilisateur, même avec des privilèges élevés dans une base de données, n'a absolument aucun accès aux objets (tables, vues, etc.) d'une autre base de données. C'est une barrière de sécurité robuste et facile à mettre en œuvre. 
 Pour chaque application, une approche à deux rôles est recommandée pour séparer la gestion du schéma de l'accès applicatif quotidien. Ceci est particulièrement pertinent pour les applications qui gèrent leurs propres migrations de base de données. 
 
 
 Un rôle de migration/propriétaire : Ce rôle (ex: wiki_owner) possède les objets de la base de données et a les privilèges nécessaires pour modifier le schéma ( CREATE, ALTER, DROP ). Ses identifiants ne sont utilisés que lors des déploiements ou des mises à jour de l'application. 
 
 
 Un rôle applicatif : Ce rôle (ex: wiki_app) dispose uniquement des privilèges de manipulation de données (DML) requis pour le fonctionnement normal de l'application : SELECT, INSERT, UPDATE, DELETE . 
 
 
 L'application est configurée pour utiliser les identifiants du rôle applicatif pour toutes ses opérations courantes. De cette manière, même si une vulnérabilité de type injection SQL est exploitée, l'attaquant ne pourra pas détruire les données ou altérer la structure de la base de données, car le rôle utilisé n'en a tout simplement pas la permission. Cette séparation des privilèges réduit drastiquement la surface d'attaque et l'impact potentiel d'un compromis. 
 4) Sécurisation du Schéma public : 
 Par défaut, dans les versions de PostgreSQL antérieures à la 15, tous les utilisateurs ont le droit de créer des objets dans le schéma public de chaque base de données. 
 5) Mise en place : 
 Le cas d'application est la création et la configuration de la base de données n8n : 
 
 
 Création des Rôles : 
 
 
 Propriétaire 
 CREATE ROLE n8n_owner WITH LOGIN PASSWORD 'mot_de_passe_owner_tres_solide';
 
 
 
 Applicatif 
 CREATE ROLE n8n_app WITH LOGIN PASSWORD 'mot_de_passe_app_tres_solide';
 
 
 
 
 
 Création de la base de données détenue par le rôle propriétaire : 
 CREATE DATABASE n8n_db WITH OWNER n8n_owner;
 
 
 
 Configuration des permissions internes : 
 -- Se connecter à la base de données
\c n8n_db

-- Retirer tous les privilèges par défaut du schema 'public'
REVOKE ALL ON SCHEMA public FROM PUBLIC;

-- Donner au propriétaire les droits sur son schéma
GRANT ALL ON SCHEMA public TO n8n_owner;

-- Donner au rôle applicatif le minimum vital
-- Droit de se connecter à la base
GRANT CONNECT ON DATABASE n8n_db TO n8n_app;

-- Droit d'utiliser le schéma (sans pouvoir y créer des objets)
GRANT USAGE ON SCHEMA public TO n8n_app;

--Droits sur les objets existants (au cas où)
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO n8n_app;

--Droit de select sur tous les schémas
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO n8n_app;

-- Toute NOUVELLE table, séquence ou fonction créée par 'n8n_owner'
-- accordera automatiquement les droits DML à 'n8n_app'.
ALTER DEFAULT PRIVILEGES FOR ROLE n8n_owner IN SCHEMA public
 GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO n8n_app;

ALTER DEFAULT PRIVILEGES FOR ROLE n8n_owner IN SCHEMA public
 GRANT USAGE, SELECT ON SEQUENCES TO n8n_app;
 
 
 
 Configuration sécurisée : contrôle qui peut se connecter, à quelle base, depuis quelle IP, et comment il doit s'authentifier.
La configuration se fait dans pg_hba.conf (Host-Based Authentication) : 
 #n8n (supposons que l'IP du serveur/conteneur n8n est 192.168.1.10)
host n8n_db n8n_owner 192.168.1.10/32 scram-sha-256
host n8n_db n8n_app 192.168.1.10/32 scram-sha-256
# --- Refus explicite ---
# Refuser toutes les autres connexions de ce sous-réseau qui n'ont pas matché
host all all 192.168.1.0/24 reject
 
 
 
 Ne pas oublier de recharger la connexion : 
 SELECT pg_reload_conf();

Suivant : [pointeur](A)