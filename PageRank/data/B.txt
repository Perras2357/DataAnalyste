Architecture du conteneur lxc postgreSQL

1) Principe et raisonnement : 
 
 Persistance de données via Bind mount 
 Permissions via chown pour que l'utilisateur postgres possède un accès aux fichiers de données 
 Propriété :
 
 propriétaire de /srv/lxc/postgres -> admin 
 propriétaire de /srv/lxc/postgres/data (data dir monté dans le conteneur) -> postgres:postgres pour que seul le processus postgres accède en écriture 
 
 
 NB : utiliser un conteneur non-priviligé (unprivileged LXC) pour limiter les risques si quelqu'un s'échappe du conteneur. 
 
 2) Implémentation : 
 a- Installation de postgresql : 
 sudo apt install postgresql
 
 Pour consulter les informations des utilisateurs crées: 
 finger postgres
 
 Toutes les opérations d'administration se font, au départ, avec l'utilisateur postgres .
À la fin de l'installation, celui-ci ne possède pas de mot de passe : 
c'est un utilisateur bloqué et le mieux est qu'il le reste. 
La première chose à faire sera de créer un nouvel utilisateur, 
mais pour ce faire, il faut se connecter au moins une fois en tant qu'utilisateur postgres. 
Pour devenir postgres et faire les opérations d'administration qui suivent, utilisez sudo : 
 $ sudo -i -u postgres 
 
 b- Création des dossiers sur l'hôte: 
 sudo mkdir -p /srv/lxc/pgsql01/data
sudo chown adminperras:adminperras /srv/lxc/pgsql01
sudo chmod 0750 /srv/lxc/pgsql01
#donner l'accès à l'utilisater postgres via iud
sudo chown -R 102:106 /srv/lxc/postgresql/data
 
 sudo chmod 700 /srv/lxc/postgresql/data
#data sera ajusté après démarrage du conteneur 
 iud récupé dans la session installation de postgres [pointeur](C)
 
 
 Ajout de l'entrée de bind mount dans la config LXC : 
 # monter /srv/lxc/postgres/data → /var/lib/postgresql/data dans le conteneur
lxc.mount.entry = /srv/lxc/postgresql/data var/lib/postgresql/17/main none bind,create=dir 0 0
 
 
 
 NB: Pour avoir le data_dir (var/lib/postgresql/17/main) il faut taper la commande : 
 sudo -u postgres psql -c "SHOW data_directory;"
 
 
 
 Démarrer le conteneur et fixer la propriété à l'intérieure 
 #lancer le conteneur
sudo lxc-start -n <ID or NAME>
#se positionner dans le conteneur
sudo lxc-attach -n <ID or NAME>
 
 
 
 c- option de montage sécurisé : 
 # exemple : monter ensuite avec noexec,nodev,nosuid (attention : noexec OK pour data dir la plupart du temps)
sudo mount --bind /srv/lxc/postgresql/data /srv/lxc/postgresql/data
sudo mount -o remount,noexec,nodev,nosuid,relatime /srv/lxc/postgresql/data
 
 
 noexec : empêche l'exécution de binaires dans le data dir (souvent OK). 
 nodev : empêche les fichiers spéciaux. 
 nosuid : neutralise setuid bits.